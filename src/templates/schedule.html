{% extends "base.html" %}

{% block head %}
<title>Horario</title>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
{% endblock %}

{% block body %}
<body class="body-schedule">
    <nav class="navbar">
    <span class="navbar-title">AKALI</span>
    <a href="{{ url_for('create_hobby') }}">Hobbies</a>
    <a href="{{ url_for('movies') }}">Películas</a>
    <a href="{{ url_for('create_schedule_item') }}">Mi horario</a>
    <a href="{{ url_for('habitos') }}">Hábitos</a>
    <a href="{{ url_for('tasks') }}">Lista de tareas</a>
    <a href="{{ url_for('games') }}">Juegos</a>
    </nav>
    <div class="navbar-spacer" aria-hidden="true"></div>

    <div class="schedule-container" x-data="{
        showModal: false,
        modalMode: '', // 'custom' or 'hobby' or 'habit' or 'task'
        selectedEventType: '',
        newEvent: {
            title: '',
            date: '',
            startTime: '',
            duration: ''
        },
        selectedHobby: null,
        selectedHabit: null,
        selectedTask: null,
        calendar: null,
        timeOptions: (() => {
            const options = [];
            for (let i = 0; i < 48; i++) {
                const hours = Math.floor(i / 2).toString().padStart(2, '0');
                const minutes = (i % 2 === 0 ? '00' : '30');
                options.push(`${hours}:${minutes}`);
            }
            return options;
        })(),
        durationOptions: [15, 30, 45, 60, 90, 120, 180, 240, 300, 360],
        calculateEndTime(startTime, duration) {
            if (!startTime || !duration) return '';
            const [hours, minutes] = startTime.split(':').map(Number);
            const durationNum = parseInt(duration);
            const totalMinutes = hours * 60 + minutes + durationNum;
            const endHours = Math.floor(totalMinutes / 60) % 24;
            const endMinutes = totalMinutes % 60;
            return `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
        },
        initializeCalendar() {
            const calendarEl = this.$refs.calendar;
            this.calendar = new FullCalendar.Calendar(calendarEl, {
                height: '100%',
                initialView: 'timeGridDay',
                customButtons: {
                    createEvent: {
                        text: 'Crear Evento',
                        click: () => {
                            this.showModal = true;
                            this.modalMode = '';
                        }
                    }
                },
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'createEvent dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '/dashboard/schedule/events',
                editable: true,
            });
            this.calendar.render();
        },
        createEvent() {
            const endTime = this.calculateEndTime(this.newEvent.startTime, this.newEvent.duration);
            var newEventData = {
                title: this.newEvent.title,
                start: `${this.newEvent.date}T${this.newEvent.startTime}`,
                end: `${this.newEvent.date}T${endTime}`,
            };

            fetch('{{ url_for('create_schedule_item') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newEventData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.calendar.addEvent(newEventData);
                    alert('¡Evento guardado!');
                    this.showModal = false;
                    this.newEvent.title = '';
                    this.newEvent.date = '';
                    this.newEvent.startTime = '';
                    this.newEvent.duration = '';
                }
            });
        },
        addHobbyToCalendar(hobby) {
            const endTime = this.calculateEndTime(this.newEvent.startTime, this.newEvent.duration);
            var newEventData = {
                title: hobby.name,
                start: `${this.newEvent.date}T${this.newEvent.startTime}`,
                end: `${this.newEvent.date}T${endTime}`,
            };

            fetch('{{ url_for('create_schedule_item') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newEventData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.calendar.addEvent(newEventData);
                    alert('¡Hobby añadido al calendario!');
                    this.showModal = false;
                    this.newEvent.date = '';
                    this.newEvent.startTime = '';
                    this.newEvent.duration = '';
                }
            });
        },
        addHabitToCalendar(habit) {
            const endTime = this.calculateEndTime(this.newEvent.startTime, this.newEvent.duration);
            var newEventData = {
                title: habit.name,
                start: `${this.newEvent.date}T${this.newEvent.startTime}`,
                end: `${this.newEvent.date}T${endTime}`,
            };

            fetch('{{ url_for('create_schedule_item') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newEventData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.calendar.addEvent(newEventData);
                    alert('¡Hábito añadido al calendario!');
                    this.showModal = false;
                    this.newEvent.date = '';
                    this.newEvent.startTime = '';
                    this.newEvent.duration = '';
                }
            });
        },
        addTaskToCalendar(task) {
            const endTime = this.calculateEndTime(this.newEvent.startTime, this.newEvent.duration);
            var newEventData = {
                title: task.name,
                start: `${this.newEvent.date}T${this.newEvent.startTime}`,
                end: `${this.newEvent.date}T${endTime}`,
            };

            fetch('{{ url_for('create_schedule_item') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newEventData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.calendar.addEvent(newEventData);
                    alert('¡Tarea añadida al calendario!');
                    this.showModal = false;
                    this.newEvent.date = '';
                    this.newEvent.startTime = '';
                    this.newEvent.duration = '';
                }
            });
        }
    }" x-init="initializeCalendar()">

        <div x-show="showModal" class="event-form">
            <div x-show="modalMode === ''">
                <h2>Qué quieres crear?</h2>
                <div class="form-group">
                    <label for="event-type-select">Tipo de Evento</label>
                    <select id="event-type-select" x-model="selectedEventType" @change="modalMode = selectedEventType">
                        <option value="" disabled>Selecciona un tipo...</option>
                        <option value="custom">Evento personalizado</option>
                        <option value="hobby">Hobby</option>
                        <option value="habit">Hábito</option>
                        <option value="task">Tarea</option>
                    </select>
                </div>
                <button type="button" @click="showModal = false" class="btn">Cancelar</button>
            </div>

            <div x-show="modalMode === 'custom'">
                <h2>Nuevo Evento</h2>
                <form @submit.prevent="createEvent()">
                    <div class="form-group">
                        <label for="event-title">Título</label>
                        <input type="text" id="event-title" x-model="newEvent.title" required>
                    </div>
                    <div class="form-group">
                        <label for="event-date">Fecha</label>
                        <input type="date" id="event-date" x-model="newEvent.date" required>
                    </div>
                    <div class="form-group">
                        <label for="event-start-time">Hora de Inicio</label>
                        <select id="event-start-time" x-model="newEvent.startTime" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona una hora</option>
                            <template x-for="time in timeOptions" :key="time">
                                <option :value="time" x-text="time"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="event-duration">Duración (minutos)</label>
                        <select id="event-duration" x-model="newEvent.duration" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona duración</option>
                            <template x-for="duration in durationOptions" :key="duration">
                                <option :value="duration" x-text="duration + ' min'"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group" x-show="newEvent.startTime && newEvent.duration">
                        <label>Hora de Fin</label>
                        <div style="padding: 12px; background-color: #f5f5f5; border: 2px solid #d0d0d0; border-radius: 6px; color: #333; font-weight: bold; font-size: 16px; text-align: center;">
                            <span x-text="calculateEndTime(newEvent.startTime, newEvent.duration)"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn">Guardar</button>
                    <button type="button" @click="modalMode = ''; selectedEventType = ''" class="btn">Volver</button>
                </form>
            </div>

            <div x-show="modalMode === 'hobby'">
                <h2>Añadir Hobby al Calendario</h2>
                <div class="hobby-list">
                    <ul>
                        {% for hobby in hobbies %}
                        <li>
                            {{ hobby.name }}
                            <button @click="selectedHobby = { name: '{{ hobby.name }}', id: {{ hobby._hobby_id }} }; modalMode = 'hobby-form'" class="btn">Seleccionar</button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <button type="button" @click="modalMode = ''; selectedEventType = ''" class="btn">Volver</button>
            </div>

            <div x-show="modalMode === 'hobby-form'">
                <h2>Añadir Hobby: <span x-text="selectedHobby ? selectedHobby.name : ''"></span></h2>
                <form @submit.prevent="addHobbyToCalendar(selectedHobby)">
                    <div class="form-group">
                        <label for="hobby-date">Fecha</label>
                        <input type="date" id="hobby-date" x-model="newEvent.date" required>
                    </div>
                    <div class="form-group">
                        <label for="hobby-start-time">Hora de Inicio</label>
                        <select id="hobby-start-time" x-model="newEvent.startTime" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona una hora</option>
                            <template x-for="time in timeOptions" :key="time">
                                <option :value="time" x-text="time"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hobby-duration">Duración (minutos)</label>
                        <select id="hobby-duration" x-model="newEvent.duration" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona duración</option>
                            <template x-for="duration in durationOptions" :key="duration">
                                <option :value="duration" x-text="duration + ' min'"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group" x-show="newEvent.startTime && newEvent.duration">
                        <label>Hora de Fin</label>
                        <div style="padding: 12px; background-color: #f5f5f5; border: 2px solid #d0d0d0; border-radius: 6px; color: #333; font-weight: bold; font-size: 16px; text-align: center;">
                            <span x-text="calculateEndTime(newEvent.startTime, newEvent.duration)"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn">Guardar</button>
                    <button type="button" @click="modalMode = 'hobby'" class="btn">Volver</button>
                </form>
            </div>

            <div x-show="modalMode === 'habit'">
                <h2>Añadir Hábito al Calendario</h2>
                <div class="habit-list">
                    <ul>
                        {% for habit in habits %}
                        <li>
                            {{ habit.name }}
                            <button @click="selectedHabit = { name: '{{ habit.name }}', id: habit.id }; modalMode = 'habit-form'" class="btn">Seleccionar</button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <button type="button" @click="modalMode = ''; selectedEventType = ''" class="btn">Volver</button>
            </div>

            <div x-show="modalMode === 'habit-form'">
                <h2>Añadir Hábito: <span x-text="selectedHabit ? selectedHabit.name : ''"></span></h2>
                <form @submit.prevent="addHabitToCalendar(selectedHabit)">
                    <div class="form-group">
                        <label for="habit-date">Fecha</label>
                        <input type="date" id="habit-date" x-model="newEvent.date" required>
                    </div>
                    <div class="form-group">
                        <label for="habit-start-time">Hora de Inicio</label>
                        <select id="habit-start-time" x-model="newEvent.startTime" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona una hora</option>
                            <template x-for="time in timeOptions" :key="time">
                                <option :value="time" x-text="time"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="habit-duration">Duración (minutos)</label>
                        <select id="habit-duration" x-model="newEvent.duration" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona duración</option>
                            <template x-for="duration in durationOptions" :key="duration">
                                <option :value="duration" x-text="duration + ' min'"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group" x-show="newEvent.startTime && newEvent.duration">
                        <label>Hora de Fin</label>
                        <div style="padding: 12px; background-color: #f5f5f5; border: 2px solid #d0d0d0; border-radius: 6px; color: #333; font-weight: bold; font-size: 16px; text-align: center;">
                            <span x-text="calculateEndTime(newEvent.startTime, newEvent.duration)"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn">Guardar</button>
                    <button type="button" @click="modalMode = 'habit'" class="btn">Volver</button>
                </form>
            </div>

            <div x-show="modalMode === 'task'">
                <h2>Añadir Tarea al Calendario</h2>
                <div class="task-list">
                    <ul>
                        {% for task in tasks %}
                        <li>
                            {{ task.name }}
                            <button @click="selectedTask = { name: '{{ task.name }}', id: task._id }; modalMode = 'task-form'" class="btn">Seleccionar</button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <button type="button" @click="modalMode = ''; selectedEventType = ''" class="btn">Volver</button>
            </div>

            <div x-show="modalMode === 'task-form'">
                <h2>Añadir Tarea: <span x-text="selectedTask ? selectedTask.name : ''"></span></h2>
                <form @submit.prevent="addTaskToCalendar(selectedTask)">
                    <div class="form-group">
                        <label for="task-date">Fecha</label>
                        <input type="date" id="task-date" x-model="newEvent.date" required>
                    </div>
                    <div class="form-group">
                        <label for="task-start-time">Hora de Inicio</label>
                        <select id="task-start-time" x-model="newEvent.startTime" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona una hora</option>
                            <template x-for="time in timeOptions" :key="time">
                                <option :value="time" x-text="time"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-duration">Duración (minutos)</label>
                        <select id="task-duration" x-model="newEvent.duration" @change="$nextTick(() => {})" required>
                            <option value="">Selecciona duración</option>
                            <template x-for="duration in durationOptions" :key="duration">
                                <option :value="duration" x-text="duration + ' min'"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group" x-show="newEvent.startTime && newEvent.duration">
                        <label>Hora de Fin</label>
                        <div style="padding: 12px; background-color: #f5f5f5; border: 2px solid #d0d0d0; border-radius: 6px; color: #333; font-weight: bold; font-size: 16px; text-align: center;">
                            <span x-text="calculateEndTime(newEvent.startTime, newEvent.duration)"></span>
                        </div>
                    </div>
                    <button type="submit" class="btn">Guardar</button>
                    <button type="button" @click="modalMode = 'task'" class="btn">Volver</button>
                </form>
            </div>
        </div>

        <div id='calendar' x-ref="calendar"></div>
    </div>

</body>
{% endblock %}
