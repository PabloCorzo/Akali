{% extends "base.html" %}

{% block head %}
<title>Horario</title>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
{% endblock %}

{% block body %}
<body class="body-schedule">
    <nav class="navbar">
    <a href="{{ url_for('create_hobby') }}">Hobbies</a>
    <a href="{{ url_for('movies') }}">Películas</a>
    <a href="{{ url_for('create_schedule_item') }}">Mi horario</a>
    <a href="{{ url_for('habitos') }}">Hábitos</a>
    <a href="{{ url_for('tasks') }}">Lista de tareas</a>
    </nav>
    <div class="navbar-spacer" aria-hidden="true"></div>

    <div class="login-box" x-data="{
        initializeCalendar() {
            const calendarEl = this.$refs.calendar; // Usamos $refs para referenciar el elemento

            const calendar = new FullCalendar.Calendar(calendarEl, {
                // La configuración es EXACTAMENTE LA MISMA que antes
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: '/dashboard/schedule/events',
                editable: true,
                selectable: true,
                select: (info) => { // Usamos una función de flecha para mantener el contexto de 'this' si fuera necesario
                    var title = prompt('Introduce el título del evento:');
                    if (title) {
                        var newEventData = {
                            title: title,
                            start: info.startStr,
                            end: info.endStr,
                        };

                        fetch('{{ url_for('create_schedule_item') }}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newEventData),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                calendar.addEvent(newEventData);
                                alert('¡Evento guardado!');
                            }
                        });
                    }
                    calendar.unselect();
                }
            });

            calendar.render();
        }
    }" x-init="initializeCalendar()"> <h1>Horario</h1>

        <div id='calendar' x-ref="calendar"></div>

    </div>

</body>
{% endblock %}